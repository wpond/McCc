
home = {x=-255,y=69,z=171}
loc = {x=-255,y=69,z=171}
dir = 0
homeDir = 0

headings = {
	"north",
	"east",
	"south",
	"west"
}

xDiff = { 0, 1, 0, -1 }
zDiff = { -1, 0, 1, 0 }

turtle_cmds =  { 
	base_tl = turtle.turnLeft,
	base_tr = turtle.turnRight,
	base_tf = turtle.forward,
	base_tb = turtle.back,
	base_tu = turtle.up,
	base_td = turtle.down
}

function loadChests()
	
	rednet.send(54, "chests")
	
	id,msg = rednet.receive()
	origin = textutils.unserialize(msg)
	
	id,msg = rednet.receive()
	input = textutils.unserialize(msg)
	
	id,msg = rednet.receive()
	reject = textutils.unserialize(msg)
	
	id,msg = rednet.receive()
	chests = textutils.unserialize(msg)
	
	print("Chests loaded: " ..tostring(#chests))
	
end

function printLocation()
	print("(x = " .. loc.x .. ", y = " .. loc.y .. ", z = " .. loc.z .. ")")
	print("Facing " .. headings[dir + 1])
end

function turnLeft()

	dir = (dir - 1) % 4;
	turtle_cmds.base_tl()
	
end

function turnRight()

	dir = (dir + 1) % 4;
	turtle_cmds.base_tr()
	
end

function up()

	if turtle_cmds.base_tu() then
		loc.y = loc.y + 1
		return true
	end
	
	return false

end

function down()

	if turtle_cmds.base_td() then
		loc.y = loc.y - 1
		return true
	end
	
	return false

end

function forward()
	
	if turtle_cmds.base_tf() then
		loc.x = loc.x + xDiff[dir+1]
		loc.z = loc.z + zDiff[dir+1]
		return true
	end
	
	return false
	
end

function back()
	
	if turtle_cmds.base_tb() then
		loc.x = loc.x - xDiff[dir+1]
		loc.z = loc.z - zDiff[dir+1]
		return true
	end
	
	return false
	
end

function face(target)
	while dir ~= target do
		turnLeft()
	end
end

function gotoY(y)
	
	if loc.y > y then
		while loc.y > y do
			if not down() then
				return false
			end
		end
	elseif loc.y < y then
		while loc.y < y do
			if not up() then
				return false
			end
		end
	end
	
	return true
	
end

function gotoZ(z)
	
	if loc.z > z then
		face(0)
		while loc.z > z do
			if not forward() then
				return false
			end
		end
	elseif loc.z < z then
		face(2)
		while loc.z < z do
			if not forward() then
				return false
			end
		end
	end
	
	return true
	
end

function gotoX(x)
	
	if loc.x < x then
		face(1)
		while loc.x < x do
			if not forward() then
				return false
			end
		end
	elseif loc.x > x then
		face(3)
		while loc.x > x do
			if not forward() then
				return false
			end
		end
	end
	
	return true
	
end

function gotoXZ(x,z)
	
	return gotoX(x) and gotoZ(z)
	
end

function gotoZX(x,z)
	
	return gotoZ(z) and gotoX(x)
	
end

function gotoChest(idx,side)
	
	local chest = chests[idx]
	
	local targetZ
	local targetFace
	
	if side == "front" then
		targetZ = origin.z + chest.loc.z - 1
		targetFace = 2
	elseif side == "back" then
		targetZ = origin.z + chest.loc.z + 1
		targetFace = 0
	else
		return
	end
	
	print("goto chest: " ..chest.desc.. "["..idx.."]")
	
	gotoY(origin.y + chest.loc.y)
	
	if loc.z == targetZ then
		gotoX(origin.x + chest.loc.x)
	else
		gotoX(origin.x)
		gotoZX(origin.x + chest.loc.x, targetZ)
	end
	
	face(targetFace)
	
end

function pickupUnsorted()
	
	gotoY(origin.y + input.loc.y)
	
	if loc.z == origin.z + input.loc.z then
		gotoX(origin.x + input.loc.x)
	else
		gotoX(origin.x)
		gotoZX(origin.x + input.loc.x, origin.z + input.loc.z)
	end
	
	face(input.face)
	
	turtle.select(1)
	for i = 1,15 do
		if not turtle.suck() then
			break
		end
	end
	gotoY(origin.y)
	gotoXZ(origin.x, origin.z)
	
end

function sort()
	
	for i = 1,#chests do
		
		if not chests[i].empty then
			
			gotoChest(i,"back")
			turtle.select(16)
			turtle.suck()
			local empty = true
			for j = 1,15 do
			
				if turtle.getItemCount(j) > 0 then
					empty = false
					
					turtle.select(j)
					if turtle.compareTo(16) then
						turtle.drop()
					end
					
				end
				
			end
			turtle.select(16)
			turtle.drop()
			
			if empty then
				return
			end
		
		end
		
	end
	
	gotoY(origin.y + reject.loc.y)
	
	if loc.z == origin.z + reject.loc.z then
		gotoX(origin.x + reject.loc.x)
	else
		gotoX(origin.x)
		gotoZX(origin.x + reject.loc.x, origin.z + reject.loc.z)
	end
	
	face(reject.face)
	
	for i = 1,15 do
		turtle.select(i)
		turtle.drop()
	end
	
end

function gotoOrigin()
	
	gotoY(origin.y)
	gotoXZ(origin.x, origin.z)
	
end

function returnHome()
	
	print("returning home")
	
	gotoY(home.y)
	gotoX(origin.x)
	gotoXZ(home.x,home.z)
	
	face(homeDir)
	
	print("home")
	
end

function main()
	
	rednet.close("right")
	rednet.open("right")
	
	loadChests()
	
	gotoOrigin()
	
	pickupUnsorted()
	sort()
	
	returnHome()
	
	rednet.close("right")
	
end

main()